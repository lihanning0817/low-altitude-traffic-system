# 前后端功能对齐修复方案

> 生成时间: 2025-10-15
> 项目: 智能低空交通系统后端

---

## 修复状态总结

### ✅ 已完成的修复

#### 1. FlightPermitController - 补充缺失接口
**文件**: `backend/src/controllers/FlightPermitController.h` 和 `.cpp`

**新增方法**:
1. `getFlightPermitById()` - GET /api/v1/flight-permits/{id} ✅
2. `revokeFlightPermit()` - POST /api/v1/flight-permits/{id}/revoke ✅

**实现细节**:
- ✅ JWT Token验证
- ✅ 权限控制(申请人或管理员才能撤销)
- ✅ 状态检查(已拒绝或已撤销的不能再撤销)
- ✅ 支持可选的撤销原因
- ✅ 完整的错误处理

---

### 🔧 需要实现的修复

#### 2. AirspaceController - Critical优先级

**文件**:
- `backend/src/controllers/AirspaceController.h` (新建)
- `backend/src/controllers/AirspaceController.cpp` (新建)

**需要实现的5个接口**:

##### 2.1 GET /api/v1/airspaces - 获取空域列表
```cpp
http::response<http::string_body> getAirspaces(
    const http::request<http::string_body>& req);
```

**功能说明**:
- 支持查询参数: type, status
- 返回空域列表数组
- 需要JWT认证

**响应格式**:
```json
{
  "success": true,
  "message": "获取空域列表成功",
  "data": {
    "airspaces": [
      {
        "id": 1,
        "name": "测试空域",
        "type": "controlled",
        "north_lat": 41.8,
        "south_lat": 41.7,
        "east_lng": 123.5,
        "west_lng": 123.4,
        "min_altitude": 0,
        "max_altitude": 500,
        "status": "active",
        "created_at": "2024-12-25 10:00:00"
      }
    ]
  }
}
```

---

##### 2.2 GET /api/v1/airspaces/{id} - 获取空域详情
```cpp
http::response<http::string_body> getAirspaceById(
    const http::request<http::string_body>& req,
    const std::string& airspace_id);
```

**功能说明**:
- 根据ID查询单个空域
- 返回完整的空域信息
- 不存在时返回404

---

##### 2.3 POST /api/v1/airspaces - 创建空域
```cpp
http::response<http::string_body> createAirspace(
    const http::request<http::string_body>& req);
```

**功能说明**:
- 需要管理员权限
- 验证必填字段: name, type, north_lat, south_lat, east_lng, west_lng
- 生成唯一的airspace_id
- 返回创建的空域对象

**请求体格式**:
```json
{
  "name": "沈阳北部禁飞区",
  "type": "restricted",
  "north_lat": 41.8,
  "south_lat": 41.7,
  "east_lng": 123.5,
  "west_lng": 123.4,
  "min_altitude": 0,
  "max_altitude": 500,
  "max_concurrent_flights": 1,
  "description": "机场附近禁飞区"
}
```

---

##### 2.4 PUT /api/v1/airspaces/{id} - 更新空域
```cpp
http::response<http::string_body> updateAirspace(
    const http::request<http::string_body>& req,
    const std::string& airspace_id);
```

**功能说明**:
- 需要管理员权限
- 支持部分更新(只更新提供的字段)
- 不存在时返回404
- 返回更新后的空域对象

---

##### 2.5 DELETE /api/v1/airspaces/{id} - 删除空域
```cpp
http::response<http::string_body> deleteAirspace(
    const http::request<http::string_body>& req,
    const std::string& airspace_id);
```

**功能说明**:
- 需要管理员权限
- 软删除或硬删除(根据业务需求)
- 检查是否有关联的飞行许可
- 不存在时返回404

---

**辅助方法** (参考FlightPermitController):
```cpp
std::string extractBearerToken(const http::request<http::string_body>& req);
int64_t validateTokenAndGetUserId(const http::request<http::string_body>& req);
bool isAdmin(int64_t user_id);
std::map<std::string, std::string> parseQueryParams(const http::request<http::string_body>& req);
```

---

#### 3. 创建airspaces数据库表

**文件**: `backend/sql/create_airspaces_table.sql`

```sql
-- 创建空域管理表
CREATE TABLE IF NOT EXISTS airspaces (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '空域ID',
    name VARCHAR(255) NOT NULL COMMENT '空域名称',
    type VARCHAR(50) NOT NULL COMMENT '空域类型: restricted(禁飞), controlled(管控), uncontrolled(非管控)',
    north_lat DECIMAL(10, 7) NOT NULL COMMENT '北纬边界',
    south_lat DECIMAL(10, 7) NOT NULL COMMENT '南纬边界',
    east_lng DECIMAL(10, 7) NOT NULL COMMENT '东经边界',
    west_lng DECIMAL(10, 7) NOT NULL COMMENT '西经边界',
    min_altitude DECIMAL(8, 2) DEFAULT 0 COMMENT '最小高度(米)',
    max_altitude DECIMAL(8, 2) DEFAULT 500 COMMENT '最大高度(米)',
    max_concurrent_flights INT DEFAULT 1 COMMENT '最大并发飞行数',
    status VARCHAR(50) DEFAULT 'active' COMMENT '状态: active(活跃), inactive(停用)',
    description TEXT COMMENT '空域描述',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    INDEX idx_type (type),
    INDEX idx_status (status),
    INDEX idx_location (north_lat, south_lat, east_lng, west_lng)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='空域管理表';

-- 插入测试数据
INSERT INTO airspaces (name, type, north_lat, south_lat, east_lng, west_lng, min_altitude, max_altitude, max_concurrent_flights, status, description)
VALUES
('沈阳故宫禁飞区', 'restricted', 41.7975, 41.7940, 123.4500, 123.4450, 0, 500, 0, 'active', '文物保护区禁飞'),
('沈阳北部管控区', 'controlled', 41.9000, 41.8000, 123.5000, 123.4000, 0, 300, 3, 'active', '需要申请许可'),
('沈阳南部开放区', 'uncontrolled', 41.7000, 41.6000, 123.4500, 123.3500, 0, 120, 10, 'active', '自由飞行区域');
```

**执行方式**:
```bash
# 连接到MySQL数据库
mysql -u root -p

# 切换到目标数据库
USE low_altitude_traffic_system;

# 执行SQL文件
SOURCE backend/sql/create_airspaces_table.sql;

# 验证表创建
SHOW TABLES LIKE 'airspaces';
DESC airspaces;
SELECT * FROM airspaces;
```

---

#### 4. DroneController - High优先级

**文件**:
- `backend/src/controllers/DroneController.h` (新建)
- `backend/src/controllers/DroneController.cpp` (新建)

**需要实现的接口**:

##### 4.1 GET /api/v1/drones - 获取无人机列表
```cpp
http::response<http::string_body> getDrones(
    const http::request<http::string_body>& req);
```

**功能说明**:
- 从SystemMonitorController迁移现有实现
- 支持查询参数: status, battery_min, model
- 返回无人机列表、总数、活跃数量

---

##### 4.2 GET /api/v1/drones/{id} - 获取无人机详情
```cpp
http::response<http::string_body> getDroneById(
    const http::request<http::string_body>& req,
    const std::string& drone_id);
```

**功能说明**:
- 根据ID查询单个无人机
- 返回完整的无人机信息(包括电池、位置、状态等)
- 不存在时返回404

**响应格式**:
```json
{
  "success": true,
  "message": "获取无人机详情成功",
  "data": {
    "id": 1,
    "device_id": "DRONE001",
    "model": "DJI Mavic 3",
    "status": "active",
    "battery_level": 85,
    "latitude": 41.8,
    "longitude": 123.4,
    "altitude": 100,
    "speed": 15.5,
    "last_update": "2024-12-25 10:30:00"
  }
}
```

---

#### 5. EmergencyLandingController - High优先级

**文件**: `backend/src/controllers/EmergencyLandingController.h` 和 `.cpp`

**需要补充的接口**:

##### 5.1 GET /api/v1/emergency-landing-points/{id} - 获取降落点详情
```cpp
http::response<http::string_body> getEmergencyLandingPointById(
    const http::request<http::string_body>& req,
    const std::string& point_id);
```

**功能说明**:
- 根据ID查询单个应急降落点
- 返回完整的降落点信息
- 不存在时返回404

---

##### 5.2 DELETE /api/v1/emergency-landing-points/{id} - 删除降落点
```cpp
http::response<http::string_body> deleteEmergencyLandingPoint(
    const http::request<http::string_body>& req,
    const std::string& point_id);
```

**功能说明**:
- 需要管理员权限
- 软删除或硬删除
- 检查是否正在被使用
- 不存在时返回404

---

#### 6. ConflictDetectionController - Medium优先级

**文件**: `backend/src/controllers/ConflictDetectionController.h` 和 `.cpp`

**需要补充的接口**:

##### 6.1 POST /api/v1/conflict-detection/flights/batch - 批量检测冲突
```cpp
http::response<http::string_body> detectMultipleFlightConflicts(
    const http::request<http::string_body>& req);
```

**请求体格式**:
```json
{
  "flights": [
    {
      "task_id": 1,
      "start_time": "2024-12-25T10:00:00Z",
      "end_time": "2024-12-25T12:00:00Z",
      "route": [[41.8, 123.4], [41.9, 123.5]],
      "altitude": 100
    },
    {
      "task_id": 2,
      "start_time": "2024-12-25T10:30:00Z",
      "end_time": "2024-12-25T11:30:00Z",
      "route": [[41.8, 123.4], [41.85, 123.45]],
      "altitude": 95
    }
  ]
}
```

---

##### 6.2 GET /api/v1/conflict-detection/conflicts/{id} - 获取冲突详情
```cpp
http::response<http::string_body> getConflictById(
    const http::request<http::string_body>& req,
    const std::string& conflict_id);
```

---

##### 6.3 GET /api/v1/conflict-detection/conflicts/statistics - 获取冲突统计
```cpp
http::response<http::string_body> getConflictStatistics(
    const http::request<http::string_body>& req);
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "total_conflicts": 45,
    "resolved_conflicts": 30,
    "pending_conflicts": 15,
    "by_severity": {
      "high": 10,
      "medium": 20,
      "low": 15
    },
    "recent_conflicts": [...]
  }
}
```

---

## 路由注册代码

需要在`backend/src/main.cpp`中添加以下路由注册代码:

```cpp
// ============ 空域管理路由 (AirspaceController) ============
auto airspaceController = std::make_shared<controllers::AirspaceController>(dbSession, jwtService);

server.addRoute("/api/v1/airspaces", Method::GET,
    [airspaceController](const auto& req) {
        return airspaceController->getAirspaces(req);
    });

server.addRoute("/api/v1/airspaces", Method::POST,
    [airspaceController](const auto& req) {
        return airspaceController->createAirspace(req);
    });

server.addRoute("/api/v1/airspaces/{id}", Method::GET,
    [airspaceController](const auto& req, const auto& params) {
        return airspaceController->getAirspaceById(req, params.at("id"));
    });

server.addRoute("/api/v1/airspaces/{id}", Method::PUT,
    [airspaceController](const auto& req, const auto& params) {
        return airspaceController->updateAirspace(req, params.at("id"));
    });

server.addRoute("/api/v1/airspaces/{id}", Method::DELETE,
    [airspaceController](const auto& req, const auto& params) {
        return airspaceController->deleteAirspace(req, params.at("id"));
    });

// ============ 无人机管理路由 (DroneController) ============
auto droneController = std::make_shared<controllers::DroneController>(dbSession, jwtService);

server.addRoute("/api/v1/drones", Method::GET,
    [droneController](const auto& req) {
        return droneController->getDrones(req);
    });

server.addRoute("/api/v1/drones/{id}", Method::GET,
    [droneController](const auto& req, const auto& params) {
        return droneController->getDroneById(req, params.at("id"));
    });

// ============ 飞行许可补充路由 ============
// 在现有的permitController路由后添加

server.addRoute("/api/v1/flight-permits/{id}", Method::GET,
    [permitController](const auto& req, const auto& params) {
        return permitController->getFlightPermitById(req, params.at("id"));
    });

server.addRoute("/api/v1/flight-permits/{id}/revoke", Method::POST,
    [permitController](const auto& req, const auto& params) {
        return permitController->revokeFlightPermit(req, params.at("id"));
    });

// ============ 应急降落点补充路由 ============
// 在现有的landingController路由后添加

server.addRoute("/api/v1/emergency-landing-points/{id}", Method::GET,
    [landingController](const auto& req, const auto& params) {
        return landingController->getEmergencyLandingPointById(req, params.at("id"));
    });

server.addRoute("/api/v1/emergency-landing-points/{id}", Method::DELETE,
    [landingController](const auto& req, const auto& params) {
        return landingController->deleteEmergencyLandingPoint(req, params.at("id"));
    });

// ============ 冲突检测补充路由 ============
// 在现有的conflictController路由后添加

server.addRoute("/api/v1/conflict-detection/flights/batch", Method::POST,
    [conflictController](const auto& req) {
        return conflictController->detectMultipleFlightConflicts(req);
    });

server.addRoute("/api/v1/conflict-detection/conflicts/{id}", Method::GET,
    [conflictController](const auto& req, const auto& params) {
        return conflictController->getConflictById(req, params.at("id"));
    });

server.addRoute("/api/v1/conflict-detection/conflicts/statistics", Method::GET,
    [conflictController](const auto& req) {
        return conflictController->getConflictStatistics(req);
    });
```

---

## 前端修复

### 统一baseURL使用代理

需要修改以下前端API文件,将硬编码的`http://localhost:8081`改为相对路径:

#### 1. flightTaskApi.js
```javascript
// 修改前
this.baseURL = 'http://localhost:8081/api/v1/tasks'

// 修改后
this.baseURL = '/api/v1/tasks'
```

#### 2. emergencyLandingApi.js
```javascript
// 修改前
this.baseURL = 'http://localhost:8081/api/v1/emergency-landing-points'

// 修改后
this.baseURL = '/api/v1/emergency-landing-points'
```

#### 3. conflictDetectionApi.js
```javascript
// 修改前
this.baseURL = 'http://localhost:8081/api/v1/conflict-detection'

// 修改后
this.baseURL = '/api/v1/conflict-detection'
```

#### 4. systemMonitorApi.js
```javascript
// 修改前
this.baseURL = 'http://localhost:8081/api/v1'

// 修改后
this.baseURL = '/api/v1'
```

---

## CMakeLists.txt更新

需要在`backend/CMakeLists.txt`中添加新的控制器源文件:

```cmake
# 添加到现有的源文件列表中
set(SOURCES
    # ... 现有源文件 ...
    src/controllers/AirspaceController.cpp
    src/controllers/DroneController.cpp
)
```

---

## 编译和部署步骤

### 1. 创建数据库表
```bash
cd backend
mysql -u root -p < sql/create_airspaces_table.sql
```

### 2. 编译后端
```bash
cd backend/build
cmake ..
cmake --build . --config Release
```

### 3. 重启后端服务
```bash
# 停止现有服务
taskkill /F /IM low_altitude_traffic_system_backend.exe

# 启动新服务
cd backend/build/Release
./low_altitude_traffic_system_backend.exe ../../config/server.json
```

### 4. 验证API
```bash
# 测试空域列表接口
curl -X GET "http://localhost:8081/api/v1/airspaces" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试飞行许可详情接口
curl -X GET "http://localhost:8081/api/v1/flight-permits/1" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试无人机详情接口
curl -X GET "http://localhost:8081/api/v1/drones/1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 测试清单

### API功能测试
- [ ] 空域CRUD完整流程
- [ ] 飞行许可详情和撤销
- [ ] 无人机详情查询
- [ ] 应急降落点详情和删除
- [ ] 冲突批量检测和统计

### 权限测试
- [ ] 非admin用户不能创建空域
- [ ] 非admin用户不能删除降落点
- [ ] 只有申请人或admin能撤销许可
- [ ] Token过期返回401
- [ ] 无Token返回401

### 数据验证测试
- [ ] 必填字段缺失返回错误
- [ ] 坐标范围验证
- [ ] 时间格式验证
- [ ] ID不存在返回404

### 前后端集成测试
- [ ] 前端调用新接口成功
- [ ] 错误信息正确显示
- [ ] Loading状态正常
- [ ] Toast通知正常

---

## 预计工作量

### Critical优先级 (1-2天)
- ✅ FlightPermitController补充接口 (已完成)
- 🔧 创建AirspaceController (4-6小时)
- 🔧 创建airspaces数据库表 (30分钟)
- 🔧 路由注册和编译 (1小时)

### High优先级 (2-3天)
- 🔧 创建DroneController (3-4小时)
- 🔧 EmergencyLandingController补充 (2-3小时)
- 🔧 前端baseURL统一 (1小时)

### Medium优先级 (1-2天)
- 🔧 ConflictDetectionController补充 (3-4小时)
- 🔧 参数调整和测试 (2-3小时)

**总预计**: 5-7个工作日

---

## 注意事项

1. **数据库事务**: 创建和删除操作要考虑事务回滚
2. **级联删除**: 删除空域前检查关联的飞行许可
3. **并发控制**: 考虑多用户同时操作的情况
4. **日志记录**: 所有关键操作都要记录日志
5. **错误处理**: 统一的错误响应格式
6. **API文档**: 建议使用Swagger生成文档
7. **单元测试**: 为新增接口编写单元测试
8. **性能优化**: 考虑添加缓存机制

---

## 下一步行动

1. **立即执行**: 创建airspaces数据库表
2. **高优先级**: 实现AirspaceController
3. **中优先级**: 实现DroneController和补充其他控制器
4. **低优先级**: 前端baseURL统一和参数调整
5. **最终**: 完整测试和文档更新

---

**修复方案文档生成完成** ✅

此文档提供了完整的实现指南，包括代码结构、数据库设计、路由配置和测试清单。
按照此方案逐步实施，可以系统性地完成前后端功能对齐。
